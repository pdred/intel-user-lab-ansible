---
- name: Check if SSH key exists
  ansible.builtin.stat:
    path: "~/.ssh/ansible_ed25519"
  register: ssh_key
  tags:
    - setup_config

- name: Install required packages
  ansible.builtin.package:
    name:
      - ansible-core
      - git
      - xauth
      - gnome-keyring
      - NetworkManager-tui
    state: present

- name: Enable X11Forwarding in SSH
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?X11Forwarding'
    line: 'X11Forwarding yes'
    state: present
  notify: restart sshd

- name: Ensure authorized_keys exists
  file:
    path: "~/.ssh/authorized_keys"
    state: touch

- name: Install required packages
  ansible.builtin.package:
    name:
      - ansible-core
      - gnome-keyring
      - git
      - xauth
      - NetworkManager-tui
      - python3-pip
    state: present
  tags:
    - packages_config

- name: Add current user to the wheel group
  user:
    name: "{{ ansible_user_id }}"
    groups: wheel
    append: true
  tags:
    - wheel_config

- name: Allow wheel group to sudo without a password
  lineinfile:
    path: /etc/sudoers
    state: present
    regexp: '^%wheel'
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'
  tags:
    - wheel_config

- name: Set local DNS server and search domain
  ansible.builtin.lineinfile:
    path: /etc/resolv.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^nameserver', line: 'nameserver 127.0.0.1' }
    - { regexp: '^search', line: 'search lab.com' }
  tags:
    - localhost_config

